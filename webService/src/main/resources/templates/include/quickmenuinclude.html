<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<style>
    .toTop{
        font-family: 'Pretendard-Regular','sans-serif';
        font-weight: bold;
        font-size: 40px;
        width: 100px;
        height: 100px;
        border-radius: 20px;
        background: linear-gradient(to bottom, #FFD99B 0%, #20537B 100%);
        color: white;
        position: relative;
        top:520px;
        display: flex;
        float: right;
        text-align: center;
        cursor: pointer;
        flex-direction: column;
    }
    .chat-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 300px;
        background: white;
        border-radius: 10px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
        display: none;
        flex-direction: column;
        justify-content: space-between;
        overflow: hidden;
    }

    .chat-header {
        background: #007bff;
        color: white;
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold;
    }

    .chat-body {
        padding: 10px;
        height: 250px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }

    .chat-input {
        display: flex;
        padding: 10px;
        border-top: 1px solid #ddd;
    }

    .chat-input textarea {
        flex: 1;
        padding: 5px;
        border-radius: 5px;
        border: 1px solid #ddd;
        resize: none;
    }

    .chat-input button {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        margin-left: 5px;
        cursor: pointer;
    }

    .message {
        padding: 8px;
        border-radius: 5px;
        margin-bottom: 5px;
        max-width: 80%;
        word-wrap: break-word;
    }

    .user-message {
        background: #007bff;
        color: white;
        align-self: flex-end;
    }

    .bot-message {
        background: #eee;
        align-self: flex-start;
    }

    .chat-icon {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #007bff;
        color: white;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
    }
</style>
<aside class="quickMenu" style="position: sticky; top: 30px;">
    <div class="bg-blue-500 border border-gray-200 rounded-lg shadow dark:bg-green-800 dark:border-gray-700">
        <div class="profileImage">
            <a href="myPage">
                <img sec:authorize="isAnonymous()" src="Img/defaultGuest.png" alt="기본 프로필">
                <!--                <th:block >-->
                <!--                </th:block>-->
                <div sec:authorize="isAuthenticated()">
                    <img sec:authorize="hasRole('ROLE_client')"  src="Img/defaultClient.png" alt="기본 프로필">
                    <!--                    <th:block th:if="${user.user_authority == 'client'}">-->
                    <!--                        <img src="Img/defaultClient.png" alt="기본 프로필">-->
                    <!--                    </th:block>-->
                    <img sec:authorize="hasRole('ROLE_doctor')"  src="Img/defaultDoctor.png" alt="기본 프로필">
                    <!--                    <th:block th:if="${user.user_authority == 'doctor'}">-->
                    <!--                        <img src="Img/defaultDoctor.png" alt="기본 프로필">-->
                    <!--                    </th:block>-->
                </div>
            </a>
        </div>
        <div class="p-5 text-white text-3xl">
            <th:block th:if="${user == null}">
                <p style="text-align: center; font-size: 25px">게스트님 환영합니다.</p>
            </th:block>
            <th:block th:unless="${user == null}">
                <p style="text-align: center; font-size: 25px"><span th:text="${user.user_name}"></span>님 환영합니다.</p>
            </th:block>
            <hr style="margin-bottom: 10px; margin-top: 10px;">
            <h1>회원 정보</h1>
            <th:block th:if="${user == null}">
                <span style="font-size: 20px"><a href="login">로그인 해주세요.</a></span>
                <hr style="margin-top: 10px; margin-bottom: 10px">
            </th:block>
            <th:block th:unless="${user == null}">
                <p style="font-size: 25px;"><span th:text="${user.user_name}"></span></p>
                <p style="font-size: 25px;"><span th:text="${user.user_email}"></span></p>
                <p id="hiddenId" style="font-size: 20px" th:text="${user.user_id}" hidden></p>
                <p id="hiddenAuth" style="font-size: 20px" th:text="${user.user_authority}" hidden></p>
                <hr style="margin-top: 10px; margin-bottom: 10px">
                <a href="myPage" onclick="checkSession()">마이페이지</a>
                <hr style="margin-top: 10px; margin-bottom: 10px">
                <th:block th:if="${user.user_authority == 'client'}">
                    <a href="reservation" onclick="checkSession()">빠른예약</a>
                    <hr style="margin-top: 10px; margin-bottom: 10px">
                    <a href="reservationStatusClient" onclick="checkSession()">예약현황</a>
                    <div>총 예약 : <span id="reservationCount1"></span> 건</div>
                    <hr style="margin-top: 10px; margin-bottom: 10px">
                </th:block>
                <th:block th:if="${user.user_authority == 'doctor'}">
                    <a href="reservationStatusDoctor" onclick="checkSession()">예약현황</a>
                    <div>대기중인 예약 : <span id="reservationCount2"></span> 건</div>
                    <hr style="margin-top: 10px; margin-bottom: 10px">
                </th:block>
            </th:block>
            <!--            <th:block th:if="${user == null}">-->
            <!--                <hr style="margin-top: 10px; margin-bottom: 10px">-->
            <!--            </th:block>-->
            <!--            <th:block th:unless="${user == null}">-->
            <!--                -->
            <!--            </th:block>-->
            <!--            <a href="/vaccinationInfo">백신정보</a>-->
            <!--            <hr style="margin-top: 10px; margin-bottom: 10px">-->
            <a href="/asklepios/search?keyword=">병원검색</a>
            <hr style="margin-top: 10px; margin-bottom: 10px">
        </div>
    </div>
    <div sec:authorize="isAnonymous()">
        <div style="position: sticky; top: 0px; cursor: pointer;" onclick="animation()">
            <div class="toTop" style="top:760px;">
                <i class="fa-solid fa-angle-up" style="position: relative; top: 8px;"></i>
                <span style="position: relative; bottom: 8px;">TOP</span>
                <!--            <div style="color: #3b82f6;font-size: 40px;font-weight: bold;position: relative;top: 60px;">TOP</div>-->
            </div>
        </div>
    </div>
    <div sec:authorize="isAuthenticated()">
        <div style="position: sticky; top: 0px; cursor: pointer;" onclick="animation()">
            <div class="toTop">
                <i class="fa-solid fa-angle-up" style="position: relative; top: 8px;"></i>
                <span style="position: relative; bottom: 8px;">TOP</span>
                <!--            <div style="color: #3b82f6;font-size: 40px;font-weight: bold;position: relative;top: 60px;">TOP</div>-->
            </div>
        </div>
    </div>
</aside>
<!-- 메시지 아이콘 -->
<div class="chat-icon" id="chatIcon" onclick="toggleChat()">
    💬
</div>

<!-- 채팅 박스 -->
<div class="chat-container" id="chatContainer">
    <div class="chat-header">
        챗봇 상담
        <span style="cursor:pointer;" onclick="toggleChat()">❌</span>
    </div>
    <div class="chat-body" id="chatBody">
        <div class="bot-message message">안녕하세요! 증상을 입력하면 진료과를 추천해드릴게요.</div>
    </div>
    <div class="chat-input">
        <textarea id="chatInput" placeholder="증상을 입력하세요..." rows="1"></textarea>
        <button onclick="sendMessage()">전송</button>
    </div>
</div>
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script>
    let userId1 = document.querySelector('#hiddenId').innerText;
    let userAuth = document.querySelector('#hiddenAuth').innerText;
    let doctorCode1;
    if(userAuth === 'doctor'){
        $.ajax({
            url: '/asklepios/findDoctorCode',
            type:'post',
            data:{
                user_id : userId1
            },
            success:function (data){
                doctorCode1 = data;
                if(doctorCode1 != null){
                    $.ajax({
                        url: '/asklepios/reservationCount',
                        type: 'post',
                        data: {
                            doctor_code: doctorCode1
                        },
                        success: function (data) {
                            document.querySelector('#reservationCount2').innerText = data;
                        },
                        error: function () {
                            alert("zz");
                        }
                    })
                }
            },
            error:function (){
                alert("zz");
            }
        })
    }
    if(userAuth === 'client'){
        $.ajax({
            url: '/asklepios/totalReservationCount',
            type: 'post',
            data: {
                user_id: userId1
            },
            success: function (data) {
                document.querySelector('#reservationCount1').innerText = data;
            },
            error: function () {
                alert("zz");
            }
        })
    }
    function animation() {
        window.scrollTo({top:0, left:0, behavior:'smooth'});
    }

    function toggleChat() {
        let chatContainer = document.getElementById("chatContainer");
        let chatIcon = document.getElementById("chatIcon");

        if (chatContainer.style.display === "none" || chatContainer.style.display === "") {
            chatContainer.style.display = "flex";
            chatIcon.style.display = "none";
        } else {
            chatContainer.style.display = "none";
            chatIcon.style.display = "flex";
        }
    }

    function sendMessage() {
        let chatInput = document.getElementById("chatInput");
        let chatBody = document.getElementById("chatBody");
        let userMessage = chatInput.value.trim();

        if (userMessage === "") {
            alert("증상을 입력해주세요.");
            return;
        }

        // 사용자 메시지 표시
        let userMsgElement = document.createElement("div");
        userMsgElement.classList.add("message", "user-message");
        userMsgElement.innerText = userMessage;
        chatBody.appendChild(userMsgElement);
        chatInput.value = "";

        // 챗봇 응답 받기
        $.ajax({
            url: "/asklepios/api/chat/recommend",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({ symptoms: userMessage }),
            success: function(response) {
                let botMsgElement = document.createElement("div");
                botMsgElement.classList.add("message", "bot-message");
                botMsgElement.innerText = "추천 진료과: " + response;
                chatBody.appendChild(botMsgElement);

                // 자동 스크롤
                chatBody.scrollTop = chatBody.scrollHeight;
            },
            error: function() {
                alert("진료과 추천 요청 실패");
            }
        });
    }
</script>